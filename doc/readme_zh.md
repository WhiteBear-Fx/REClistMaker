# 顺畅录音表生成器

简体中文 | [English](./../readme.md)

## 简介

这是一个用python编写的简单程序，可以生成顺口的CVVC或VCV录音表，目前暂时只支持命令行使用。

## 如何使用

程序通过一个 `.toml` 格式的 `字典` 生成 `录音表` 和 `oto.ini` 模板，也可以在 `.toml` 和 `presamp.ini` 之间互相转换。

下文介绍将字典格式和程序可用参数

### 符号表

- S：音节，一个完整的发音符号，如 “da”。
- L：左元，CVVC的C部分，如 “da” 的左元为 “d”。
- R：右元，CVVC的V部分，如 “da” 的右元为 “a”。

**特殊音素，例如语尾息、喉塞音等，不应作为任何元。**
  
### 字典

程序通过一个 TOML 文件定义音节和基本行为，格式如下：

```toml
version = "1.0.0"

[syl]
da = ["d", "a"]
ta = ["t", "a"]
# ... 更多音节定义

[config]
n_fade = ["k", "t", "p", "ch"]
end_flag = true
```

#### 字段说明

- **`version`**（必填）  
  配置文件格式的版本号，当前必须大于等于 `"1.0.0"` （且大于 `1.0.0` 无实际意义）。

- **`[syl]`**（必填）  
  音节映射表。每个条目格式为 `S = ["L", "R"]`。  
  例如 `da = ["d", "a"]` 表示音节 `da` 的左元（L）是 `d`，右元（R）是 `a`。  
  程序会根据所有音节自动生成元音表、辅音表。

- **`[config]`**（可选）  
  控制生成行为的额外选项，包含以下字段：

  - **`n_fade`**（数组，可选）  
    需要 **禁用** 交叉淡化的辅音组列表。  
    对应 `presamp.ini` 中 `[CONSONANT]` 的 `crossfade flag = 1`（即不进行交叉渐变）。  
    通常爆破音（如 `k`, `t`, `p`, `ch`）需要关闭淡化，其他辅音默认开启（`=0`）。

  - **`end_flag`**（布尔值，可选，默认为 `true`）  
    是否自动为休止符添加结尾音素（如 `R`）。  
    对应 `presamp.ini` 的 `[ENDFLAG]` 功能。`true` 表示启用。

其他 `presamp.ini` 中的配置（如元音表、辅音表）均由程序自动从 `[syl]` 推导。

**请注意，未提及的所有配置项，转换后都会丢失。**

## 命令行参考

版本：0.0.1

### 全局选项

- **`-v, --version`**  
  显示程序版本号并退出。

- **`-h, --help`**  
  显示帮助信息（由 argparse 自动生成）。

### 命令概述

程序通过子命令执行不同操作。当前支持三个命令：`generate`（别名 `gen`）、`from_presamp`（别名 `fp`）、`to_presamp`（别名 `tp`）。使用时必须指定一个子命令。

---

#### `generate` 命令（别名 `gen`）

**用途**：根据 `.toml` 音节字典生成 `.txt` 录音表文件， `oto.ini` 模板及 `presamp.ini`。

录音表由若干行组成，每行是一串音节序列（如 S1, S2, S3）。程序根据用户提供的音节集合（每个音节由左元 L 和右元 R 定义）和所选模式（CVVC 或 VCV），生成一张覆盖所有必需过渡成分的表格，同时尽可能让每一行内的相邻音节“顺口”。顺口性分为完全顺口（相邻音节共享左元或右元）和周期交替顺口（按固定周期重复类别）。程序通过搜索算法构造行序列，以下参数可控制搜索行为。

- **`-i, --input`**（必需）  
  输入的 TOML 格式音节词典文件路径。

- **`-o, --output`**（可选）  
  输出文件的路径（不含文件名）。程序会生成：`<输出路径>/REClist.txt` ， `<输出路径>/oto.ini` 和 `<输出路径>/presamp.ini`。若不指定，则根据输入文件名自动生成。

- **`-m, --mode`**（可选，默认 `CVVC`）  
  选择生成模式，可选 `VCV` 、`CVVC` 或 `VCV_WITH_VC`。

- **`-b, --bpm`**（可选，默认 `120`）  
  录音背景音乐的速度（BPM），用于生成 `oto.ini` 模板。

- **`-l, --max-length`**（可选，默认 `6`）  
  每行最多包含的音节数量，取值范围 2 到 8。

- **`-s, --SSS-first`**（可选，标志）  
  优先使用三音节重复模式排列，即类似 `da_da_da` 的序列，可以将第三字读长，用作 `L` 后缀的长音使用。

- **`-d, --iter-depth`**（可选）  
  寻找最优排列顺序时的最大迭代深度，但会增加计算时间，且未必顺口。默认值和最大值均为 `-l` 参数的一半。

- **`-r, --max-redundancy`**（可选，默认 `50`）  
  允许为提升顺口性而额外添加的冗余音节数量上限。

---

#### `from_presamp` 命令（别名 `fp`）

**用途**：将已有的 `presamp.ini` 配置文件转换为程序使用的 TOML 音节词典格式，方便编辑或重新生成录音表。

- **`-i, --input`**（必需）  
  输入的 `presamp.ini` 文件路径。

- **`-o, --output`**（可选）  
  输出的 TOML 文件路径（不含文件名）。若不指定，则在输入文件同目录下生成同名但扩展名为 `.toml` 的文件。

---

#### `to_presamp` 命令（别名 `tp`）

**用途**：将程序使用的 TOML 音节词典文件转换为 `presamp.ini` 配置文件，以便与现有 UTAU 工具链（如 `autocvvc.exe`）配合使用。

- **`-i, --input`**（必需）  
  输入的 TOML 音节词典文件路径。

- **`-o, --output`**（可选）  
  输出的 `presamp.ini` 文件路径（不含文件名）。若不指定，则在输入文件同目录下生成 `presamp.ini`。
  